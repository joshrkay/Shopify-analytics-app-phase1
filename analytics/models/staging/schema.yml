version: 2

models:
  - name: _tenant_airbyte_connections
    description: Helper model that exposes tenant_airbyte_connections for staging models
    columns:
      - name: airbyte_connection_id
        description: Airbyte connection ID
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier
        tests:
          - not_null
      - name: source_type
        description: Type of data source
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['shopify']

  - name: stg_shopify_orders
    description: Staging model for Shopify orders with normalized fields and tenant isolation
    columns:
      - name: order_id
        description: Normalized order ID (primary key)
        tests:
          - not_null
          - unique
      - name: order_name
        description: Order name/number from Shopify
      - name: order_number
        description: Order number as integer
      - name: report_date
        description: Order date (staging contract standard field, derived from created_at)
        tests:
          - not_null
      - name: customer_email
        description: Customer email address
      - name: customer_id_raw
        description: Raw customer ID from Shopify (may need normalization)
      - name: created_at
        description: Order creation timestamp (UTC)
        tests:
          - not_null
      - name: updated_at
        description: Order last update timestamp (UTC)
      - name: cancelled_at
        description: Order cancellation timestamp (UTC, nullable)
      - name: closed_at
        description: Order closure timestamp (UTC, nullable)
      - name: total_price
        description: Total order price (numeric)
        tests:
          - not_null
      - name: subtotal_price
        description: Subtotal price (numeric)
      - name: total_tax
        description: Total tax amount (numeric)
      - name: currency
        description: Currency code (uppercase)
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CNY']
              config:
                where: "currency is not null"
      - name: financial_status
        description: Financial status of the order
      - name: fulfillment_status
        description: Fulfillment status of the order
      - name: tags
        description: Order tags
      - name: note
        description: Order notes
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('_tenant_airbyte_connections')
                field: tenant_id
              config:
                where: "tenant_id is not null"
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_shopify_customers
    description: Staging model for Shopify customers with normalized fields and tenant isolation
    columns:
      - name: customer_id
        description: Normalized customer ID (primary key)
        tests:
          - not_null
          - unique
      - name: email
        description: Customer email address
        tests:
          - not_null
      - name: first_name
        description: Customer first name
      - name: last_name
        description: Customer last name
      - name: full_name
        description: Full name (first + last or email)
      - name: phone
        description: Customer phone number
      - name: created_at
        description: Customer creation timestamp (UTC)
        tests:
          - not_null
      - name: updated_at
        description: Customer last update timestamp (UTC)
      - name: accepts_marketing
        description: Whether customer accepts marketing (boolean)
      - name: verified_email
        description: Whether email is verified (boolean)
      - name: orders_count
        description: Number of orders (integer)
        tests:
          - not_null
      - name: total_spent
        description: Total amount spent (numeric)
        tests:
          - not_null
      - name: currency
        description: Currency code (uppercase)
        tests:
          - not_null
      - name: state
        description: Customer state
      - name: country_code
        description: Country code from default address
      - name: city
        description: City from default address
      - name: tags
        description: Customer tags
      - name: note
        description: Customer notes
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('_tenant_airbyte_connections')
                field: tenant_id
              config:
                where: "tenant_id is not null"
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_meta_ads
    description: >
      Staging model for Meta Ads (Facebook/Instagram) with normalized fields,
      tenant isolation, and Option B ID normalization.
    columns:
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              to: ref('_tenant_airbyte_connections')
              field: tenant_id
              config:
                where: "tenant_id is not null"

      - name: report_date
        description: Date of the ad performance (staging contract standard field)
        tests:
          - not_null

      - name: date
        description: Date of the ad performance (kept for backward compatibility)
        tests:
          - not_null

      - name: date_stop
        description: End date of the ad performance period

      - name: source
        description: Source identifier for cross-platform joins
        tests:
          - not_null
          - accepted_values:
              values: ['meta_ads']

      - name: ad_account_id
        description: Meta Ads account ID (platform-specific)
        tests:
          - not_null

      - name: campaign_id
        description: Campaign ID (platform-specific)
        tests:
          - not_null

      - name: adset_id
        description: Ad set ID

      - name: ad_id
        description: Ad ID

      - name: internal_account_id
        description: Deterministic hash ID for cross-platform account joins
        tests:
          - not_null
          - relationships:
              to: ref('dim_ad_accounts')
              field: internal_account_id

      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
        tests:
          - not_null
          - relationships:
              to: ref('dim_campaigns')
              field: internal_campaign_id

      - name: platform_channel
        description: Platform-specific channel/placement
        tests:
          - not_null

      - name: canonical_channel
        description: Normalized channel from taxonomy
        tests:
          - not_null
          - accepted_values:
              values: ['paid_social', 'paid_search', 'paid_shopping', 'email', 'organic_social', 'organic_search', 'direct', 'referral', 'affiliate', 'other']

      - name: spend
        description: Amount spent (numeric, normalized currency)
        tests:
          - not_null

      - name: impressions
        description: Number of impressions (integer)
        tests:
          - not_null

      - name: clicks
        description: Number of clicks (integer)
        tests:
          - not_null

      - name: conversions
        description: Number of conversions (numeric)
        tests:
          - not_null

      - name: conversion_value
        description: Value of conversions (numeric)
        tests:
          - not_null

      - name: currency
        description: Currency code (uppercase, 3-letter)
        tests:
          - not_null
          - accepted_values:
              values: ['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CNY']
              config:
                where: "currency is not null"

      - name: cpm
        description: Cost per mille (thousand impressions) - calculated

      - name: cpc
        description: Cost per click - calculated

      - name: ctr
        description: Click-through rate (percentage) - calculated

      - name: cpa
        description: Cost per acquisition - calculated

      - name: roas_platform
        description: Platform ROAS (conversion_value / spend) - calculated

      - name: campaign_name
        description: Campaign name

      - name: adset_name
        description: Ad set name

      - name: ad_name
        description: Ad name

      - name: objective
        description: Campaign objective

      - name: reach
        description: Number of unique people reached

      - name: frequency
        description: Average frequency

      - name: cpp
        description: Cost per purchase (from platform)

      - name: platform
        description: Platform identifier (kept for backward compatibility)
        tests:
          - not_null
          - accepted_values:
              values: ['meta_ads']

      - name: airbyte_record_id
        description: Airbyte record ID

      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_google_ads
    description: >
      Staging model for Google Ads with normalized fields,
      tenant isolation, and Option B ID normalization.
    columns:
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              to: ref('_tenant_airbyte_connections')
              field: tenant_id
              config:
                where: "tenant_id is not null"

      - name: report_date
        description: Date of the ad performance (staging contract standard field)
        tests:
          - not_null

      - name: date
        description: Date of the ad performance (kept for backward compatibility)
        tests:
          - not_null

      - name: source
        description: Source identifier for cross-platform joins
        tests:
          - not_null
          - accepted_values:
              values: ['google_ads']

      - name: ad_account_id
        description: Google Ads customer ID (platform-specific)
        tests:
          - not_null

      - name: campaign_id
        description: Campaign ID (platform-specific)
        tests:
          - not_null

      - name: ad_group_id
        description: Ad group ID

      - name: ad_id
        description: Ad ID

      - name: internal_account_id
        description: Deterministic hash ID for cross-platform account joins
        tests:
          - not_null
          - relationships:
              to: ref('dim_ad_accounts')
              field: internal_account_id

      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
        tests:
          - not_null
          - relationships:
              to: ref('dim_campaigns')
              field: internal_campaign_id

      - name: platform_channel
        description: Platform-specific channel/network
        tests:
          - not_null

      - name: canonical_channel
        description: Normalized channel from taxonomy
        tests:
          - not_null
          - accepted_values:
              values: ['paid_social', 'paid_search', 'paid_shopping', 'email', 'organic_social', 'organic_search', 'direct', 'referral', 'affiliate', 'other']

      - name: spend
        description: Amount spent (numeric, normalized from micros or decimal)
        tests:
          - not_null

      - name: impressions
        description: Number of impressions (integer)
        tests:
          - not_null

      - name: clicks
        description: Number of clicks (integer)
        tests:
          - not_null

      - name: conversions
        description: Number of conversions (numeric)
        tests:
          - not_null

      - name: conversion_value
        description: Value of conversions (numeric)
        tests:
          - not_null

      - name: currency
        description: Currency code (uppercase, 3-letter)
        tests:
          - not_null
          - accepted_values:
              values: ['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CNY']
              config:
                where: "currency is not null"

      - name: cpm
        description: Cost per mille (thousand impressions) - calculated

      - name: cpc
        description: Cost per click - calculated

      - name: ctr
        description: Click-through rate (percentage) - calculated

      - name: cpa
        description: Cost per acquisition - calculated

      - name: roas_platform
        description: Platform ROAS (conversion_value / spend) - calculated

      - name: campaign_name
        description: Campaign name

      - name: ad_group_name
        description: Ad group name

      - name: ad_type
        description: Type of ad

      - name: device
        description: Device type

      - name: network
        description: Network type

      - name: average_cpc
        description: Average cost per click (from platform)

      - name: cost_per_conversion
        description: Cost per conversion (from platform)

      - name: platform
        description: Platform identifier (kept for backward compatibility)
        tests:
          - not_null
          - accepted_values:
              values: ['google_ads']

      - name: airbyte_record_id
        description: Airbyte record ID

      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

sources:
  - name: airbyte_raw
    description: Raw Airbyte data tables
    # Schema where Airbyte writes raw tables - configurable via dbt vars
    # Default: 'airbyte_raw' (matches CI and typical Airbyte setup)
    # Override with: dbt run --vars '{airbyte_raw_schema: your_schema}'
    schema: "{{ var('airbyte_raw_schema', 'airbyte_raw') }}"
    freshness:
      warn_after: {count: 24, period: hour}
      error_after: {count: 48, period: hour}
    tables:
      - name: _airbyte_raw_shopify_orders
        description: Raw Shopify orders data from Airbyte
        loaded_at_field: _airbyte_emitted_at
        columns:
          - name: _airbyte_ab_id
            description: Airbyte record ID
            tests:
              - not_null
          - name: _airbyte_emitted_at
            description: Timestamp when record was emitted by Airbyte
            tests:
              - not_null
          - name: _airbyte_data
            description: JSONB column containing the actual order data
            tests:
              - not_null
      
      - name: _airbyte_raw_shopify_customers
        description: Raw Shopify customers data from Airbyte
        loaded_at_field: _airbyte_emitted_at
        columns:
          - name: _airbyte_ab_id
            description: Airbyte record ID
            tests:
              - not_null
          - name: _airbyte_emitted_at
            description: Timestamp when record was emitted by Airbyte
            tests:
              - not_null
          - name: _airbyte_data
            description: JSONB column containing the actual customer data
            tests:
              - not_null
      
      - name: _airbyte_raw_meta_ads
        description: Raw Meta Ads data from Airbyte
        loaded_at_field: _airbyte_emitted_at
        columns:
          - name: _airbyte_ab_id
            description: Airbyte record ID
            tests:
              - not_null
          - name: _airbyte_emitted_at
            description: Timestamp when record was emitted by Airbyte
            tests:
              - not_null
          - name: _airbyte_data
            description: JSONB column containing the actual ad data
            tests:
              - not_null
      
      - name: _airbyte_raw_google_ads
        description: Raw Google Ads data from Airbyte
        loaded_at_field: _airbyte_emitted_at
        columns:
          - name: _airbyte_ab_id
            description: Airbyte record ID
            tests:
              - not_null
          - name: _airbyte_emitted_at
            description: Timestamp when record was emitted by Airbyte
            tests:
              - not_null
          - name: _airbyte_data
            description: JSONB column containing the actual ad data
            tests:
              - not_null

  - name: platform
    description: Platform tables for tenant mapping and configuration
    # Schema where platform tables live - configurable via dbt vars
    # Default: 'platform' (matches CI and typical deployment setup)
    # Override with: dbt run --vars '{platform_schema: your_schema}'
    schema: "{{ var('platform_schema', 'platform') }}"
    tables:
      - name: tenant_airbyte_connections
        description: Maps Airbyte connections to tenants for data isolation
        columns:
          - name: airbyte_connection_id
            description: Airbyte connection ID
            tests:
              - not_null
          - name: tenant_id
            description: Tenant identifier
            tests:
              - not_null
          - name: source_type
            description: Type of data source (e.g., shopify)
            tests:
              - not_null
          - name: status
            description: Connection status
            tests:
              - not_null
          - name: is_enabled
            description: Whether connection is enabled
            tests:
              - not_null
