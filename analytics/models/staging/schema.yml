version: 2

models:
  - name: dim_tenant
    description: |
      Tenant dimension with timezone support for date normalization (User Story 7.7.1).

      Provides tenant-level attributes including timezone for normalizing
      timestamps to tenant local dates. Currently defaults to UTC; will be
      updated when tenant timezone data source is available.
    columns:
      - name: tenant_id
        description: Tenant identifier
        tests:
          - not_null
          - unique
      - name: timezone
        description: IANA timezone string for the tenant (default UTC)
        tests:
          - not_null
      - name: dbt_updated_at
        description: Timestamp when record was last updated by dbt
        tests:
          - not_null

  - name: _tenant_airbyte_connections
    description: Helper model that exposes tenant_airbyte_connections for staging models
    columns:
      - name: airbyte_connection_id
        description: Airbyte connection ID
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier
        tests:
          - not_null
      - name: source_type
        description: Type of data source
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['shopify', 'source-shopify', 'source-facebook-marketing', 'source-google-ads']
      - name: shop_domain
        description: Normalized shop domain for Shopify connections (lowercase, no protocol)

  - name: stg_shopify_orders
    description: >
      Staging model for Shopify orders with strict typing, standardization, and dedup.
      Includes record_sk (stable surrogate key), source_system, source_primary_key.
      Deduplicates by (tenant_id, order_id) keeping the latest Airbyte emission.
    columns:
      - name: record_sk
        description: Stable surrogate key md5(tenant_id || source_system || source_primary_key)
        tests:
          - not_null
          - unique
      - name: source_system
        description: Source system identifier
        tests:
          - not_null
          - accepted_values:
              values: ['shopify']
      - name: source_primary_key
        description: Natural key from source (order_id)
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('_tenant_airbyte_connections')
                field: tenant_id
              config:
                where: "tenant_id is not null"
      - name: order_id
        description: Normalized order ID (primary key)
        tests:
          - not_null
      - name: order_name
        description: Order name/number from Shopify
      - name: order_number
        description: Order number as integer
      - name: report_date
        description: Order date (staging contract standard field, derived from created_at)
        tests:
          - not_null
      - name: customer_email
        description: Customer email address
      - name: customer_id_raw
        description: Raw customer ID from Shopify (may need normalization)
      - name: created_at
        description: Order creation timestamp (UTC)
        tests:
          - not_null
      - name: updated_at
        description: Order last update timestamp (UTC)
      - name: cancelled_at
        description: Order cancellation timestamp (UTC, nullable)
      - name: closed_at
        description: Order closure timestamp (UTC, nullable)
      - name: total_price
        description: Total order price (numeric)
        tests:
          - not_null
      - name: subtotal_price
        description: Subtotal price (numeric)
      - name: total_tax
        description: Total tax amount (numeric)
      - name: currency
        description: Currency code (uppercase)
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['USD', 'EUR', 'GBP', 'CAD', 'AUD', 'JPY', 'CNY']
              config:
                where: "currency is not null"
      - name: financial_status
        description: Financial status of the order
      - name: fulfillment_status
        description: Fulfillment status of the order
      - name: tags
        description: Order tags
      - name: note
        description: Order notes
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_shopify_customers
    description: Staging model for Shopify customers with normalized fields and tenant isolation
    columns:
      - name: customer_id
        description: Normalized customer ID (primary key)
        tests:
          - not_null
          - unique
      - name: email
        description: Customer email address
        tests:
          - not_null
      - name: first_name
        description: Customer first name
      - name: last_name
        description: Customer last name
      - name: full_name
        description: Full name (first + last or email)
      - name: phone
        description: Customer phone number
      - name: created_at
        description: Customer creation timestamp (UTC)
        tests:
          - not_null
      - name: updated_at
        description: Customer last update timestamp (UTC)
      - name: accepts_marketing
        description: Whether customer accepts marketing (boolean)
      - name: verified_email
        description: Whether email is verified (boolean)
      - name: orders_count
        description: Number of orders (integer)
        tests:
          - not_null
      - name: total_spent
        description: Total amount spent (numeric)
        tests:
          - not_null
      - name: currency
        description: Currency code (uppercase)
        tests:
          - not_null
      - name: state
        description: Customer state
      - name: country_code
        description: Country code from default address
      - name: city
        description: City from default address
      - name: tags
        description: Customer tags
      - name: note
        description: Customer notes
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('_tenant_airbyte_connections')
                field: tenant_id
              config:
                where: "tenant_id is not null"
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_facebook_ads_performance
    description: >
      Staging model for Meta Ads (Facebook/Instagram) with strict typing, standardization,
      and dedup. Includes record_sk, source_system, source_primary_key.
      No derived business metrics (cpm, cpc, ctr, cpa, roas) - deferred to canonical layer.
    columns:
      - name: record_sk
        description: Stable surrogate key md5(tenant_id || source_system || source_primary_key)
        tests:
          - not_null
          - unique
      - name: source_system
        description: Source system identifier
        tests:
          - not_null
          - accepted_values:
              values: ['meta_ads']
      - name: source_primary_key
        description: Natural key from source (ad_account_id|campaign_id|adset_id|ad_id|date)
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
      - name: report_date
        description: Date of the ad performance (staging contract standard field)
        tests:
          - not_null
      - name: date
        description: Date of the ad performance
        tests:
          - not_null
      - name: date_stop
        description: End date of the ad performance period
      - name: source
        description: Source identifier for cross-platform joins
        tests:
          - not_null
          - accepted_values:
              values: ['meta_ads']
      - name: ad_account_id
        description: Meta Ads account ID (platform-specific)
        tests:
          - not_null
      - name: campaign_id
        description: Campaign ID (platform-specific)
        tests:
          - not_null
      - name: adset_id
        description: Ad set ID
      - name: ad_id
        description: Ad ID
      - name: internal_account_id
        description: Deterministic hash ID for cross-platform account joins
        tests:
          - not_null
      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
        tests:
          - not_null
      - name: platform_channel
        description: Platform-specific channel/placement
        tests:
          - not_null
      - name: canonical_channel
        description: Normalized channel from taxonomy
        tests:
          - not_null
          - accepted_values:
              values: ['paid_social', 'paid_search', 'paid_shopping', 'email', 'organic_social', 'organic_search', 'direct', 'referral', 'affiliate', 'other']
      - name: spend
        description: Amount spent (numeric, normalized currency)
        tests:
          - not_null
      - name: impressions
        description: Number of impressions (integer)
        tests:
          - not_null
      - name: clicks
        description: Number of clicks (integer)
        tests:
          - not_null
      - name: conversions
        description: Number of conversions (numeric)
        tests:
          - not_null
      - name: conversion_value
        description: Value of conversions (numeric)
        tests:
          - not_null
      - name: currency
        description: Currency code (uppercase, 3-letter)
        tests:
          - not_null
      - name: campaign_name
        description: Campaign name
      - name: adset_name
        description: Ad set name
      - name: ad_name
        description: Ad name
      - name: objective
        description: Campaign objective
      - name: reach
        description: Number of unique people reached
      - name: frequency
        description: Average frequency
      - name: platform
        description: Platform identifier
        tests:
          - not_null
          - accepted_values:
              values: ['meta_ads']
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_google_ads_performance
    description: >
      Staging model for Google Ads with strict typing, standardization, and dedup.
      Includes record_sk, source_system, source_primary_key.
      No derived business metrics (cpm, cpc, ctr, cpa, roas) - deferred to canonical layer.
    columns:
      - name: record_sk
        description: Stable surrogate key md5(tenant_id || source_system || source_primary_key)
        tests:
          - not_null
          - unique
      - name: source_system
        description: Source system identifier
        tests:
          - not_null
          - accepted_values:
              values: ['google_ads']
      - name: source_primary_key
        description: Natural key from source (ad_account_id|campaign_id|ad_group_id|ad_id|date)
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
      - name: report_date
        description: Date of the ad performance (staging contract standard field)
        tests:
          - not_null
      - name: date
        description: Date of the ad performance
        tests:
          - not_null
      - name: source
        description: Source identifier for cross-platform joins
        tests:
          - not_null
          - accepted_values:
              values: ['google_ads']
      - name: ad_account_id
        description: Google Ads customer ID (platform-specific)
        tests:
          - not_null
      - name: campaign_id
        description: Campaign ID (platform-specific)
        tests:
          - not_null
      - name: ad_group_id
        description: Ad group ID
      - name: ad_id
        description: Ad ID
      - name: internal_account_id
        description: Deterministic hash ID for cross-platform account joins
        tests:
          - not_null
      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
        tests:
          - not_null
      - name: platform_channel
        description: Platform-specific channel/network
        tests:
          - not_null
      - name: canonical_channel
        description: Normalized channel from taxonomy
        tests:
          - not_null
          - accepted_values:
              values: ['paid_social', 'paid_search', 'paid_shopping', 'email', 'organic_social', 'organic_search', 'direct', 'referral', 'affiliate', 'other']
      - name: spend
        description: Amount spent (numeric, normalized from micros or decimal)
        tests:
          - not_null
      - name: impressions
        description: Number of impressions (integer)
        tests:
          - not_null
      - name: clicks
        description: Number of clicks (integer)
        tests:
          - not_null
      - name: conversions
        description: Number of conversions (numeric)
        tests:
          - not_null
      - name: conversion_value
        description: Value of conversions (numeric)
        tests:
          - not_null
      - name: currency
        description: Currency code (uppercase, 3-letter)
        tests:
          - not_null
      - name: campaign_name
        description: Campaign name
      - name: ad_group_name
        description: Ad group name
      - name: ad_type
        description: Type of ad
      - name: device
        description: Device type
      - name: network
        description: Network type
      - name: platform
        description: Platform identifier
        tests:
          - not_null
          - accepted_values:
              values: ['google_ads']
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_tiktok_ads_performance
    description: >
      Staging model for TikTok Ads with strict typing, standardization, and dedup.
      Includes record_sk, source_system, source_primary_key.
      Returns empty result if source table doesn't exist yet.
      No derived business metrics - deferred to canonical layer.
    columns:
      - name: record_sk
        description: Stable surrogate key md5(tenant_id || source_system || source_primary_key)
        tests:
          - not_null
          - unique
      - name: source_system
        description: Source system identifier
        tests:
          - not_null
          - accepted_values:
              values: ['tiktok_ads']
      - name: source_primary_key
        description: Natural key from source (ad_account_id|campaign_id|adgroup_id|ad_id|date)
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
      - name: report_date
        description: Date of the ad performance
        tests:
          - not_null
      - name: date
        description: Date of the ad performance
        tests:
          - not_null
      - name: source
        description: Source identifier for cross-platform joins
        tests:
          - not_null
          - accepted_values:
              values: ['tiktok_ads']
      - name: ad_account_id
        description: TikTok Ads advertiser ID
        tests:
          - not_null
      - name: campaign_id
        description: Campaign ID
        tests:
          - not_null
      - name: adgroup_id
        description: Ad group ID
      - name: ad_id
        description: Ad ID
      - name: internal_account_id
        description: Deterministic hash ID for cross-platform account joins
        tests:
          - not_null
      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
        tests:
          - not_null
      - name: platform_channel
        description: Platform-specific channel/placement
        tests:
          - not_null
      - name: canonical_channel
        description: Normalized channel from taxonomy
        tests:
          - not_null
          - accepted_values:
              values: ['paid_social', 'paid_search', 'paid_shopping', 'email', 'organic_social', 'organic_search', 'direct', 'referral', 'affiliate', 'other']
      - name: spend
        description: Amount spent (numeric)
        tests:
          - not_null
      - name: impressions
        description: Number of impressions (integer)
        tests:
          - not_null
      - name: clicks
        description: Number of clicks (integer)
        tests:
          - not_null
      - name: conversions
        description: Number of conversions (numeric)
        tests:
          - not_null
      - name: conversion_value
        description: Value of conversions (numeric)
        tests:
          - not_null
      - name: currency
        description: Currency code (uppercase, 3-letter)
        tests:
          - not_null
      - name: campaign_name
        description: Campaign name
      - name: adgroup_name
        description: Ad group name
      - name: ad_name
        description: Ad name
      - name: objective
        description: Campaign objective
      - name: reach
        description: Number of unique people reached
      - name: frequency
        description: Average frequency
      - name: platform
        description: Platform identifier
        tests:
          - not_null
          - accepted_values:
              values: ['tiktok_ads']
      - name: airbyte_record_id
        description: Airbyte record ID
      - name: airbyte_emitted_at
        description: Airbyte emission timestamp

  - name: stg_email_campaigns
    description: >
      Staging model for email campaign metrics aggregated from Klaviyo events.
      Includes record_sk, source_system, source_primary_key.
      Provides raw count metrics only (no derived rates) - deferred to canonical layer.
    columns:
      - name: record_sk
        description: Stable surrogate key md5(tenant_id || source_system || source_primary_key)
        tests:
          - not_null
          - unique
      - name: source_system
        description: Source system identifier
        tests:
          - not_null
          - accepted_values:
              values: ['klaviyo']
      - name: source_primary_key
        description: Natural key from source (campaign_id|report_date)
        tests:
          - not_null
      - name: tenant_id
        description: Tenant identifier for data isolation
        tests:
          - not_null
      - name: campaign_id
        description: Klaviyo campaign ID
        tests:
          - not_null
      - name: campaign_name
        description: Campaign name
      - name: report_date
        description: Date of the campaign metrics
        tests:
          - not_null
      - name: source
        description: Source identifier
        tests:
          - not_null
      - name: internal_campaign_id
        description: Deterministic hash ID for cross-platform campaign joins
      - name: platform_channel
        description: Channel type (always 'email')
        tests:
          - not_null
      - name: canonical_channel
        description: Canonical channel (always 'email')
        tests:
          - not_null
      - name: sends
        description: Number of emails sent
      - name: deliveries
        description: Number of emails delivered
      - name: opens
        description: Total email opens
      - name: unique_opens
        description: Unique email opens
      - name: clicks
        description: Total email clicks
      - name: unique_clicks
        description: Unique email clicks
      - name: bounces
        description: Number of bounced emails
      - name: spam_complaints
        description: Number of spam complaints
      - name: unsubscribes
        description: Number of unsubscribes
      - name: conversions
        description: Number of conversions
      - name: unique_recipients
        description: Approximate unique recipients
      - name: revenue
        description: Revenue from conversions
      - name: currency
        description: Currency code
      - name: platform
        description: Platform identifier (always 'klaviyo')
        tests:
          - not_null
      - name: airbyte_emitted_at
        description: Latest Airbyte emission timestamp for the aggregation
