name: CI - Epic 0 Quality Gates

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  quality-gates:
    name: Epic 0 Platform Quality Gates
    runs-on: ubuntu-latest
    
    # CRITICAL: Fail fast if quality gates don't pass
    # This job MUST pass before PR can be merged
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-mock
      
      - name: Set up test environment variables
        env:
          FRONTEGG_CLIENT_ID: "test-client-id"
          FRONTEGG_CLIENT_SECRET: "test-client-secret"
          DATABASE_URL: "sqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379"
          ENV: "test"
        run: |
          echo "Test environment variables configured"
      
      - name: Run Epic 0 Quality Gate Tests
        working-directory: ./backend
        env:
          FRONTEGG_CLIENT_ID: "test-client-id"
          FRONTEGG_CLIENT_SECRET: "test-client-secret"
          DATABASE_URL: "sqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379"
          ENV: "test"
          PYTHONPATH: "${{ github.workspace }}/backend"
        run: |
          echo "=========================================="
          echo "Running Epic 0 Quality Gate Tests"
          echo "=========================================="
          pytest src/tests/platform/test_platform_gate.py \
            -v \
            --tb=short \
            --strict-markers \
            --disable-warnings \
            -m "not slow" || exit 1
      
      - name: Run Tenant Isolation Tests
        working-directory: ./backend
        env:
          FRONTEGG_CLIENT_ID: "test-client-id"
          FRONTEGG_CLIENT_SECRET: "test-client-secret"
          DATABASE_URL: "sqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379"
          ENV: "test"
          PYTHONPATH: "${{ github.workspace }}/backend"
        run: |
          echo "=========================================="
          echo "Running Tenant Isolation Tests"
          echo "=========================================="
          pytest src/tests/platform/test_tenant_isolation.py \
            -v \
            --tb=short \
            --strict-markers \
            --disable-warnings || exit 1
      
      - name: Quality Gate Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Epic 0 Quality Gate Test Results"
          echo "=========================================="
          echo "✓ Tenant Isolation: Verified"
          echo "✓ RBAC Enforcement: Verified"
          echo "✓ Secrets Redaction: Verified"
          echo "✓ Audit Logging: Verified"
          echo "✓ Feature Flag Kill Switch: Verified"
          echo ""
          echo "All quality gates must pass for PR merge."
      
      - name: Fail if tests failed
        if: failure()
        run: |
          echo "::error::Epic 0 Quality Gates FAILED"
          echo "::error::PR merge is BLOCKED until all tests pass"
          echo "::error::Review test output above for details"
          exit 1

  # Additional job for full platform test suite
  platform-tests:
    name: Full Platform Test Suite
    runs-on: ubuntu-latest
    needs: quality-gates  # Only run if quality gates pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-mock
      
      - name: Run all platform tests
        working-directory: ./backend
        env:
          FRONTEGG_CLIENT_ID: "test-client-id"
          FRONTEGG_CLIENT_SECRET: "test-client-secret"
          DATABASE_URL: "sqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379"
          ENV: "test"
          PYTHONPATH: "${{ github.workspace }}/backend"
        run: |
          pytest src/tests/platform/ \
            -v \
            --tb=short \
            --cov=src/platform \
            --cov=src/repositories \
            --cov-report=term-missing \
            --cov-report=xml || exit 1
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./backend/coverage.xml
          flags: platform
          name: platform-tests

  # Billing regression tests with ephemeral database
  billing-regression-tests:
    name: Billing Regression Tests
    runs-on: ubuntu-latest
    needs: quality-gates  # Only run if quality gates pass

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_billing_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-asyncio pytest-mock pytest-cov pytest-timeout

      - name: Run Billing Regression Tests
        working-directory: ./backend
        env:
          DATABASE_URL: "postgresql://test:test@localhost:5432/test_billing_db"
          SHOPIFY_API_SECRET: "test-webhook-secret-for-hmac"
          SHOPIFY_BILLING_TEST_MODE: "true"
          FRONTEGG_CLIENT_ID: "test-client-id"
          FRONTEGG_CLIENT_SECRET: "test-client-secret"
          REDIS_URL: "redis://localhost:6379"
          ENV: "test"
          PYTHONPATH: "${{ github.workspace }}/backend"
        run: |
          echo "=========================================="
          echo "Running Billing Regression Tests"
          echo "=========================================="
          pytest src/tests/regression/test_billing_regression.py \
            -v \
            --tb=short \
            -m "regression" \
            --timeout=600 \
            --cov=src/services/billing_service \
            --cov=src/api/routes/webhooks_shopify \
            --cov=src/jobs/reconcile_subscriptions \
            --cov-report=term-missing || exit 1

      - name: Billing Regression Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Billing Regression Test Results"
          echo "=========================================="
          echo "Test Coverage:"
          echo "  1. Checkout URL Happy Path"
          echo "  2. Webhook Subscription Activation"
          echo "  3. Plan Upgrade Flow"
          echo "  4. Cancellation Flow"
          echo "  5. Failed Payment Handling"
          echo "  6. Reconciliation Drift Correction"
          echo "  7. HMAC Security Verification"
          echo "  8. Cross-Tenant Isolation"

  # dbt validation: validates dbt models, schema, and data quality
  dbt-validation:
    name: dbt Validation
    runs-on: ubuntu-latest
    needs: quality-gates  # Only run if quality gates pass

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_dbt_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dbt dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres

      - name: Configure dbt profiles
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "Creating profiles.yml from template..."
          cp profiles.yml.example profiles.yml
          echo "dbt profiles configured via environment variables"
          echo "Profiles file location: $(pwd)/profiles.yml"

      - name: Run dbt debug
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "=========================================="
          echo "Running dbt debug"
          echo "=========================================="
          dbt debug --profiles-dir . --project-dir . || exit 1

      - name: Install dbt packages
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "=========================================="
          echo "Installing dbt packages"
          echo "=========================================="
          dbt deps --profiles-dir . --project-dir . || exit 1

      - name: Run dbt compile
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "=========================================="
          echo "Compiling dbt models"
          echo "=========================================="
          dbt compile --profiles-dir . --project-dir . || exit 1

      - name: Run dbt run (staging models)
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "=========================================="
          echo "Running dbt models (staging+)"
          echo "=========================================="
          dbt run --select staging+ --profiles-dir . --project-dir . || exit 1

      - name: Run dbt test
        working-directory: ./analytics
        env:
          DB_HOST: localhost
          DB_USER: test
          DB_PASSWORD: test
          DB_PORT: 5432
          DB_NAME: test_dbt_db
          DB_SSLMODE: disable
        run: |
          echo "=========================================="
          echo "Running dbt tests"
          echo "=========================================="
          dbt test --profiles-dir . --project-dir . || exit 1

      - name: dbt Validation Summary
        if: always()
        run: |
          echo "=========================================="
          echo "dbt Validation Results"
          echo "=========================================="
          echo "✓ dbt connection verified"
          echo "✓ Models compiled successfully"
          echo "✓ Staging models built"
          echo "✓ Data quality tests passed"
          echo ""
          echo "Schema/logic changes validated before merge."

  # Block PR merge if quality gates fail
  pr-check:
    name: PR Merge Gate
    runs-on: ubuntu-latest
    needs: [quality-gates, platform-tests, billing-regression-tests, dbt-validation]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Verify quality gates passed
        run: |
          echo "✓ All Epic 0 Quality Gates passed"
          echo "✓ PR is eligible for merge"
          echo ""
          echo "Next steps:"
          echo "1. Code review approval"
          echo "2. Merge to main"
          echo "3. Auto-deploy to Render (if configured)"